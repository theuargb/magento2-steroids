<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:module:Magento_Config:etc/system_file.xsd">
    <system>
        <tab id="theuargb" translate="label" sortOrder="900">
            <label>Theuargb</label>
        </tab>
        <section id="steroids" translate="label" type="text" sortOrder="100" showInDefault="1" showInWebsite="1" showInStore="1">
            <label>AI Self-Healing</label>
            <tab>theuargb</tab>
            <resource>Theuargb_Steroids::config</resource>

            <!-- General -->
            <group id="general" translate="label" type="text" sortOrder="10" showInDefault="1" showInWebsite="1" showInStore="1">
                <label>General Settings</label>
                <field id="enabled" translate="label" type="select" sortOrder="10" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Enable AI Self-Healing</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                </field>
            </group>

            <!-- LLM Configuration -->
            <group id="llm" translate="label" type="text" sortOrder="20" showInDefault="1" showInWebsite="1" showInStore="1">
                <label>LLM Configuration</label>
                <field id="provider" translate="label comment" type="select" sortOrder="10" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>LLM Preset</label>
                    <source_model>Theuargb\Steroids\Model\Config\Source\LlmProvider</source_model>
                    <comment><![CDATA[
                        Select a pre-configured LLM preset or choose <b>Custom</b> to configure provider, model and base URL manually.<br/>
                        Presets: <b>OpenAI Realtime</b> (gpt-4o-realtime-preview, WebSocket), <b>OpenAI GPT-5</b> (gpt-5),
                        <b>Anthropic Haiku 4.5</b> (claude-haiku-4-5-20250514), <b>Google Gemini 3 Flash</b> (gemini-3.0-flash via OpenAI-compatible API).
                    ]]></comment>
                </field>
                <field id="api_key" translate="label comment" type="obscure" sortOrder="20" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>API Key</label>
                    <backend_model>Magento\Config\Model\Config\Backend\Encrypted</backend_model>
                    <comment>API key for the selected LLM provider.</comment>
                </field>
                <field id="custom_provider" translate="label comment" type="select" sortOrder="25" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Provider Type</label>
                    <source_model>Theuargb\Steroids\Model\Config\Source\CustomProviderType</source_model>
                    <comment>Select the underlying AI provider type for your custom configuration.</comment>
                    <depends>
                        <field id="provider">custom</field>
                    </depends>
                </field>
                <field id="model" translate="label comment" type="text" sortOrder="30" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Model</label>
                    <comment>Model name, e.g. gpt-4o, claude-sonnet-4-20250514, gpt-4o-realtime-preview, etc.</comment>
                    <depends>
                        <field id="provider">custom</field>
                    </depends>
                </field>
                <field id="base_url" translate="label comment" type="text" sortOrder="40" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Custom Base URL (optional)</label>
                    <comment>For OpenAI-compatible proxies or self-hosted endpoints. Leave empty for default provider URL.</comment>
                    <depends>
                        <field id="provider">custom</field>
                    </depends>
                </field>
            </group>

            <!-- Agent Settings -->
            <group id="agent" translate="label" type="text" sortOrder="25" showInDefault="1" showInWebsite="1" showInStore="1">
                <label>Agent Settings</label>
                <field id="heal_timeout_seconds" translate="label comment" type="text" sortOrder="20" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Heal Timeout (seconds)</label>
                    <validate>validate-number validate-greater-than-zero</validate>
                    <comment>Max time for the healing agent loop. Default: 30.</comment>
                </field>
                <field id="fallback_timeout_seconds" translate="label comment" type="text" sortOrder="30" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Fallback Timeout (seconds)</label>
                    <validate>validate-number validate-greater-than-zero</validate>
                    <comment>Max time to generate fallback HTML. Default: 15.</comment>
                </field>
                <field id="fallback_cache_ttl_seconds" translate="label comment" type="text" sortOrder="35" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Fallback Cache TTL (seconds)</label>
                    <validate>validate-number validate-greater-than-zero</validate>
                    <comment>How long to keep cached fallback responses. Default: 3600 (1 hour). Set to 0 to disable TTL (cache until manual flush).</comment>
                </field>
                <field id="max_tool_calls" translate="label comment" type="text" sortOrder="40" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Max Tool Calls per Healing</label>
                    <validate>validate-number validate-greater-than-zero</validate>
                    <comment>Limit the number of tool invocations per healing attempt. Default: 10.</comment>
                </field>
            </group>

            <!-- URL Rules -->
            <group id="url_filters" translate="label" type="text" sortOrder="30" showInDefault="1" showInWebsite="1" showInStore="1">
                <label>URL Rules</label>
                <field id="url_rules" translate="label comment" sortOrder="10" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label></label>
                    <frontend_model>Theuargb\Steroids\Block\Adminhtml\System\Config\UrlRules</frontend_model>
                    <backend_model>Magento\Config\Model\Config\Backend\Serialized\ArraySerialized</backend_model>
                    <comment><![CDATA[
                        Define URL patterns with per-URL healing and fallback configuration. <b>First match wins</b> — order matters.<br/>
                        <b>Pattern</b>: URL pattern with wildcards (e.g., <code>/checkout/*</code>, <code>/catalog/product/*</code>, <code>*</code> for all).<br/>
                        <b>Healer Instructions</b>: Admin guidance for the healing agent when this URL fails (e.g., "May clear caches but do NOT modify payment data").<br/>
                        <b>Fallback Instructions</b>: Admin guidance for fallback response generation (e.g., "Show 301 redirect to /" or "Return friendly 404 page").<br/>
                        <b>Try Healing</b>: 1 = attempt automatic fix, 0 = skip healing, go straight to fallback.<br/>
                        <b>Allow Fallback</b>: 1 = generate fallback HTML/redirect if healing fails, 0 = show standard error.<br/>
                        <b>Cache Fallback</b>: 1 = cache the fallback response (keyed by URL + error + customer context) for instant serving on repeat errors, 0 = always regenerate.<br/>
                        <b>Enabled</b>: 1 = rule is active, 0 = rule is ignored.<br/>
                        <b>No rules configured = module does not intercept any URLs.</b>
                    ]]></comment>
                </field>
            </group>

            <!-- Design JSON -->
            <group id="design" translate="label" sortOrder="50" showInDefault="1" showInWebsite="1" showInStore="1">
                <label>Fallback Page Design</label>
                <field id="design_json" translate="label comment" type="textarea" sortOrder="10" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Design / Branding JSON</label>
                    <comment><![CDATA[
                        Free-form JSON describing the store's visual design for fallback pages.<br/>
                        You can populate this manually, or use the Firecrawl scraper below to extract branding automatically.<br/>
                        Example structure (any shape is accepted — the AI will interpret it):<br/>
                        <pre>{
  "store_name": "My Store",
  "logo_url": "https://example.com/logo.svg",
  "fonts": [
    {"family": "Inter", "url": "https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700"}
  ],
  "colors": {
    "primary": "#2563EB",
    "background": "#FFFFFF",
    "text": "#1F2937",
    "accent": "#F59E0B"
  },
  "style_notes": "Modern, clean, rounded corners, subtle shadows"
}</pre>
                    ]]></comment>
                </field>
                <field id="firecrawl_api_key" translate="label comment" type="obscure" sortOrder="20" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Firecrawl API Key</label>
                    <backend_model>Magento\Config\Model\Config\Backend\Encrypted</backend_model>
                    <comment><![CDATA[API key for <a href="https://firecrawl.dev" target="_blank">Firecrawl</a> branding extraction service. Used only for manual "Scrape Branding" action.]]></comment>
                </field>
                <field id="firecrawl_store_url" translate="label comment" type="text" sortOrder="30" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label>Store URL to Scrape</label>
                    <comment>The store homepage URL that Firecrawl will analyze for branding extraction. Editable — defaults to your store's base URL.</comment>
                </field>
                <field id="scrape_branding" translate="label" sortOrder="40" showInDefault="1" showInWebsite="1" showInStore="1">
                    <label></label>
                    <frontend_model>Theuargb\Steroids\Block\Adminhtml\System\Config\ScrapeBranding</frontend_model>
                </field>
            </group>

            <!-- Safety & Limits -->
            <group id="safety" translate="label" sortOrder="60" showInDefault="1">
                <label>Safety &amp; Limits</label>
                <field id="max_attempts_per_fingerprint_per_hour" translate="label comment" type="text" sortOrder="10" showInDefault="1">
                    <label>Max Healing Attempts per Error Fingerprint per Hour</label>
                    <validate>validate-number validate-greater-than-zero</validate>
                    <comment>Circuit breaker: stops retrying the same error. Default: 3.</comment>
                </field>
                <field id="max_concurrent_healings" translate="label comment" type="text" sortOrder="20" showInDefault="1">
                    <label>Max Concurrent Healing Requests</label>
                    <validate>validate-number validate-greater-than-zero</validate>
                    <comment>Prevents stampede. Default: 2.</comment>
                </field>
                <field id="disallowed_tool_actions" translate="label comment" type="textarea" sortOrder="30" showInDefault="1">
                    <label>Disallowed Agent Tool Actions</label>
                    <comment>One per line. E.g.: write_file, magento_cli, eval_php</comment>
                </field>
                <field id="allow_file_writes" translate="label comment" type="select" sortOrder="40" showInDefault="1">
                    <label>Allow File Writes</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>When Yes, agent can use write_file tool to persist patches. When No, agent can only diagnose, clear caches, and apply in-memory fixes via eval_php.</comment>
                </field>
            </group>

        </section>
    </system>
</config>
